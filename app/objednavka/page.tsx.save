84
'use client'
import { useState, useEffect, Suspense } from 'react'
import Turnstile from '@/components/Turnstile'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { ArrowLeft, Package, FileText, ShoppingBag, MapPin, Clock, Crown, CheckCircle, Star, User, Building2 } from 'lucide-react'

function OrderForm() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const isReorder = searchParams.get('reorder') === 'true'
  const [customer, setCustomer] = useState<any>(null)
  const [favoriteAddresses, setFavoriteAddresses] = useState<any[]>([])
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [isSuccess, setIsSuccess] = useState(false)
  const [finalPrice, setFinalPrice] = useState(0)
  const [error, setError] = useState('')
  const [turnstileToken, setTurnstileToken] = useState('')
  
  const [formData, setFormData] = useState({
    // Odosielateľ
    customer_name: '',
    customer_email: '',
    customer_phone: '',
    // Vyzdvihnutie
    pickup_company: '',
    pickup_name: '',
    pickup_surname: '',
    pickup_street: '',
    pickup_city: '',
    pickup_postal: '',
    pickup_country: 'Slovensko',
    pickup_phone: '',
    pickup_email: '',
    pickup_notes: '',
    // Doručenie
    delivery_company: '',
    delivery_name: '',
    delivery_surname: '',
    delivery_street: '',
    delivery_city: '',
    delivery_postal: '',
    delivery_country: 'Slovensko',
    delivery_phone: '',
    delivery_email: '',
    delivery_notes: '',
    // Objednávka
    order_notes: '',
    package_type: 'document',
    service_type: 'standard',
    insurance: 0,
    reverse_delivery: false
  })


  useEffect(() => {
    const saved = localStorage.getItem('customer')
    if (saved) {
      const c = JSON.parse(saved)
      setCustomer(c)
      setFormData(prev => ({
        ...prev,
        customer_name: c.account_type === 'company' ? c.company_name : `${c.first_name} ${c.last_name}`,
        customer_email: c.email,
        customer_phone: c.phone || '',
        pickup_street: c.street || '',
        pickup_city: c.city || '',
        pickup_postal: c.postal_code || ''
      }))
      fetchFavoriteAddresses(c.id)
    }

    if (isReorder) {
      const reorderData = localStorage.getItem('reorder')
      if (reorderData) {
        const data = JSON.parse(reorderData)
        setFormData(prev => ({ ...prev, ...data }))
        localStorage.removeItem('reorder')
      }
    }
  }, [isReorder])

  const fetchFavoriteAddresses = async (customerId: string) => {
      const data = await res.json()
      setFavoriteAddresses(data.addresses || [])
    } catch (err) {
      console.error(err)
    }
  }

  const prices: Record<string, number> = { standard: 4.90, express: 7.90, premium: 12.90 }
  const price = prices[formData.service_type] || 4.90

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)
    setError('')
    try {

      // Verify Turnstile
      const verifyRes = await fetch('/api/verify-turnstile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: turnstileToken })
      })
      if (!verifyRes.ok) {
        throw new Error('Verifikácia zlyhala.')
      }
      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...formData,
          price,
          pickup_address: `${formData.pickup_street}, ${formData.pickup_postal} ${formData.pickup_city}, ${formData.pickup_country}`,
          delivery_address: `${formData.delivery_street}, ${formData.delivery_postal} ${formData.delivery_city}, ${formData.delivery_country}`,
          recipient_name: formData.delivery_name,
          recipient_surname: formData.delivery_surname,
          recipient_phone: formData.delivery_phone,
          recipient_email: formData.delivery_email
        })
      })
      const data = await res.json()
      if (!res.ok) throw new Error(data.error)
      setFinalPrice(price)
      setIsSuccess(true)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Niečo sa pokazilo')
    } finally {
      setIsSubmitting(false)
    }
  }

  if (isSuccess) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        <div className="max-w-lg mx-auto p-6 pt-12">
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 text-center shadow-sm">
            <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
              <CheckCircle className="w-10 h-10 text-white" />
            </div>
            <h1 className="text-2xl font-bold mb-2 dark:text-white">Objednávka prijatá!</h1>
            <p className="text-gray-600 dark:text-gray-400 mb-6">Kuriér bude priradený čo najskôr.</p>
            <div className="bg-gray-100 dark:bg-gray-700 rounded-xl p-4 mb-6">
              <p className="text-gray-500 dark:text-gray-400 text-sm">Celková cena</p>
              <p className="text-3xl font-bold dark:text-white">{finalPrice.toFixed(2)} €</p>
            </div>
            <Link href="/" className="block w-full py-4 bg-black text-white rounded-xl font-semibold">
              Späť na hlavnú stránku
            </Link>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
      <div className="max-w-2xl mx-auto p-6">
        <button onClick={() => router.back()} className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full mb-4">
          <ArrowLeft className="w-6 h-6 dark:text-white" />
        </button>
        <h1 className="text-2xl font-bold mb-6 dark:text-white">
          {isReorder ? 'Objednať znova' : 'Nová objednávka'}
        </h1>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Kontaktné údaje odosielateľa */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white flex items-center gap-2">
              <User className="w-5 h-5" /> Odosielateľ
            </h2>
            <div className="space-y-4">
              <input type="text" placeholder="Meno a priezvisko *" value={formData.customer_name} onChange={e => setFormData({...formData, customer_name: e.target.value})} className="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="email" placeholder="Email *" value={formData.customer_email} onChange={e => setFormData({...formData, customer_email: e.target.value})} className="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="tel" placeholder="Telefón *" value={formData.customer_phone} onChange={e => setFormData({...formData, customer_phone: e.target.value})} className="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
            </div>
          </div>

          {/* Adresa vyzdvihnutia */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white flex items-center gap-2">
              <MapPin className="w-5 h-5" /> Adresa vyzdvihnutia
            </h2>
            <div className="grid grid-cols-2 gap-3">
              <input type="text" placeholder="Firma (voliteľné)" value={formData.pickup_company} onChange={e => setFormData({...formData, pickup_company: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" />
              <input type="text" placeholder="Meno *" value={formData.pickup_name} onChange={e => setFormData({...formData, pickup_name: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="Priezvisko *" value={formData.pickup_surname} onChange={e => setFormData({...formData, pickup_surname: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="Ulica a číslo *" value={formData.pickup_street} onChange={e => setFormData({...formData, pickup_street: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="Mesto *" value={formData.pickup_city} onChange={e => setFormData({...formData, pickup_city: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="PSČ *" value={formData.pickup_postal} onChange={e => setFormData({...formData, pickup_postal: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <select value={formData.pickup_country} onChange={e => setFormData({...formData, pickup_country: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl">
                <option value="Slovensko">Slovensko</option>
                <option value="Česko">Česko</option>
                <option value="Rakúsko">Rakúsko</option>
                <option value="Maďarsko">Maďarsko</option>
                <option value="Poľsko">Poľsko</option>
              </select>
              <input type="tel" placeholder="Telefón *" value={formData.pickup_phone} onChange={e => setFormData({...formData, pickup_phone: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="email" placeholder="Email" value={formData.pickup_email} onChange={e => setFormData({...formData, pickup_email: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" />
              <textarea placeholder="Poznámky (poschodie, zvonček...)" value={formData.pickup_notes} onChange={e => setFormData({...formData, pickup_notes: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" rows={2} />
            </div>
          </div>

          {/* Adresa doručenia */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white flex items-center gap-2">
              <MapPin className="w-5 h-5" /> Adresa doručenia
            </h2>
            <div className="grid grid-cols-2 gap-3">
              <input type="text" placeholder="Firma (voliteľné)" value={formData.delivery_company} onChange={e => setFormData({...formData, delivery_company: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" />
              <input type="text" placeholder="Meno *" value={formData.delivery_name} onChange={e => setFormData({...formData, delivery_name: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="Priezvisko *" value={formData.delivery_surname} onChange={e => setFormData({...formData, delivery_surname: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="Ulica a číslo *" value={formData.delivery_street} onChange={e => setFormData({...formData, delivery_street: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="Mesto *" value={formData.delivery_city} onChange={e => setFormData({...formData, delivery_city: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="text" placeholder="PSČ *" value={formData.delivery_postal} onChange={e => setFormData({...formData, delivery_postal: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <select value={formData.delivery_country} onChange={e => setFormData({...formData, delivery_country: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl">
                <option value="Slovensko">Slovensko</option>
                <option value="Česko">Česko</option>
                <option value="Rakúsko">Rakúsko</option>
                <option value="Maďarsko">Maďarsko</option>
                <option value="Poľsko">Poľsko</option>
              </select>
              <input type="tel" placeholder="Telefón *" value={formData.delivery_phone} onChange={e => setFormData({...formData, delivery_phone: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" required />
              <input type="email" placeholder="Email (notifikácie)" value={formData.delivery_email} onChange={e => setFormData({...formData, delivery_email: e.target.value})} className="px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" />
              <textarea placeholder="Poznámky (poschodie, zvonček...)" value={formData.delivery_notes} onChange={e => setFormData({...formData, delivery_notes: e.target.value})} className="col-span-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl" rows={2} />
            </div>
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-3">Príjemca dostane SMS/email s tracking linkom</p>
          </div>

          {/* Typ zásielky */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white">Typ zásielky</h2>
            <div className="grid grid-cols-3 gap-3">
              {[
                { id: 'document', icon: FileText, label: 'Dokument' },
                { id: 'package', icon: Package, label: 'Balík' },
                { id: 'other', icon: ShoppingBag, label: 'Iné' }
              ].map(type => (
                <button key={type.id} type="button" onClick={() => setFormData({...formData, package_type: type.id})}
                  className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${formData.package_type === type.id ? 'border-black dark:border-white bg-gray-50 dark:bg-gray-700' : 'border-gray-200 dark:border-gray-600'}`}>
                  <type.icon className="w-6 h-6 dark:text-white" />
                  <span className="text-sm dark:text-white">{type.label}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Typ služby */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white">Rýchlosť doručenia</h2>
            <div className="space-y-3">
              {[
                { id: 'standard', icon: Clock, label: 'Štandard', desc: 'Do 120 minút', price: '4,90 €' },
                { id: 'express', icon: MapPin, label: 'Express', desc: 'Do 60 minút', price: '7,90 €' },
                { id: 'premium', icon: Crown, label: 'Premium', desc: 'Do 45 minút', price: '12,90 €' }
              ].map(service => (
                <button key={service.id} type="button" onClick={() => setFormData({...formData, service_type: service.id})}
                  className={`w-full p-4 rounded-xl border-2 flex items-center justify-between ${formData.service_type === service.id ? 'border-black dark:border-white bg-gray-50 dark:bg-gray-700' : 'border-gray-200 dark:border-gray-600'}`}>
                  <div className="flex items-center gap-3">
                    <service.icon className="w-5 h-5 dark:text-white" />
                    <div className="text-left">
                      <p className="font-medium dark:text-white">{service.label}</p>
                      <p className="text-sm text-gray-500 dark:text-gray-400">{service.desc}</p>
                    </div>
                  </div>
                  <p className="font-semibold dark:text-white">{service.price}</p>
                </button>
              ))}
            </div>
          </div>

          {/* Poistenie zásielky */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white">Poistenie zásielky</h2>
            <div className="space-y-3">
              {[
                { value: 0, label: "Bez poistenia", price: "0 €" },
                { value: 100, label: "Poistenie do 100 €", price: "+1 €" },
                { value: 500, label: "Poistenie do 500 €", price: "+3 €" },
                { value: 1000, label: "Poistenie do 1000 €", price: "+5 €" }
              ].map(ins => (
                <button key={ins.value} type="button" onClick={() => setFormData({...formData, insurance: ins.value})}
                  className={`w-full p-4 rounded-xl border-2 flex items-center justify-between ${formData.insurance === ins.value ? "border-black dark:border-white bg-gray-50 dark:bg-gray-700" : "border-gray-200 dark:border-gray-600"}`}>
                  <span className="dark:text-white">{ins.label}</span>
                  <span className="font-semibold dark:text-white">{ins.price}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Reverse Delivery */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="font-bold dark:text-white">Spiatočná zásielka</h2>
                <p className="text-sm text-gray-500 dark:text-gray-400">Kuriér prinesie podpísané dokumenty späť</p>
              </div>
              <button type="button" onClick={() => setFormData({...formData, reverse_delivery: !formData.reverse_delivery})}
                className={`w-14 h-8 rounded-full transition-colors ${formData.reverse_delivery ? "bg-black dark:bg-white" : "bg-gray-300 dark:bg-gray-600"}`}>
                <div className={`w-6 h-6 rounded-full bg-white dark:bg-gray-800 shadow transform transition-transform ${formData.reverse_delivery ? "translate-x-7" : "translate-x-1"}`} />
              </button>
            </div>
            {formData.reverse_delivery && (
              <p className="mt-3 text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 p-3 rounded-xl">+ 50% k cene doručenia</p>
            )}
          </div>

          {/* Poznámka k objednávke */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm">
            <h2 className="font-bold mb-4 dark:text-white">Poznámka k objednávke</h2>
            <textarea 
              placeholder="Špeciálne inštrukcie, krehký tovar, volať pred doručením..." 
              value={formData.order_notes} 
              onChange={e => setFormData({...formData, order_notes: e.target.value})} 
              className="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl min-h-[100px] resize-none"
            />
          </div>

          {error && <p className="text-red-500 text-center">{error}</p>}

          {/* Submit */}
          <div className="bg-black text-white rounded-2xl p-6">
            <div className="flex justify-between items-center mb-4">
              <span className="text-gray-400">Celková cena</span>
              <span className="text-3xl font-bold">{price.toFixed(2)} €</span>
            </div>
            <Turnstile onVerify={setTurnstileToken} />
            <button type="submit" disabled={isSubmitting || !turnstileToken} className="w-full py-4 bg-white text-black font-semibold rounded-xl disabled:opacity-50">
              {isSubmitting ? 'Odosielam...' : 'Odoslať objednávku'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}

export default function OrderPage() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center"><p className="dark:text-white">Načítavam...</p></div>}>
      <OrderForm />
    </Suspense>
  )
}
